-- SERVICES
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")

-- SETTINGS
local Enabled = false
local TeamCheck = true
local WallCheck = false
local Holding = false
local SmoothAim = true
local FOV = 150
local Smoothness = 0.12
local AimPart = "Head"
local Target = nil
local TargetHumanoid = nil

-- FOV CIRCLE
local Circle = Drawing.new("Circle")
Circle.Visible = false
Circle.Thickness = 1
Circle.Filled = false
Circle.Radius = FOV
Circle.Color = Color3.fromRGB(255,255,255)

-- TARGET HIGHLIGHT
local TargetCircle = Drawing.new("Circle")
TargetCircle.Visible = false
TargetCircle.Thickness = 2
TargetCircle.Filled = false
TargetCircle.Radius = 12
TargetCircle.Color = Color3.fromRGB(255,0,0)

-- UI
local gui = Instance.new("ScreenGui", game.CoreGui)
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 240, 0, 280)
frame.Position = UDim2.new(0.05, 0, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
frame.Active = true
frame.Draggable = true

local function makeButton(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(1,-20,0,30)
	b.Position = UDim2.new(0,10,0,y)
	b.Text = text
	b.BackgroundColor3 = Color3.fromRGB(50,50,50)
	b.TextColor3 = Color3.fromRGB(255,255,255)
	return b
end

local enableBtn = makeButton("Aimbot: OFF", 10)
local teamBtn = makeButton("TeamCheck: ON", 50)
local wallBtn = makeButton("WallCheck: OFF", 90)
local smoothBtn = makeButton("Smooth Aim: ON", 130)
local partBtn = makeButton("Aim Part: Head", 170)
local iyBtn = makeButton("Infinite Yield", 210)

local fovBox = Instance.new("TextBox", frame)
fovBox.Size = UDim2.new(1,-20,0,30)
fovBox.Position = UDim2.new(0,10,0,250)
fovBox.Text = "FOV: "..FOV
fovBox.BackgroundColor3 = Color3.fromRGB(45,45,45)
fovBox.TextColor3 = Color3.fromRGB(255,255,255)

-- UI LOGIC
enableBtn.MouseButton1Click:Connect(function()
	Enabled = not Enabled
	enableBtn.Text = "Aimbot: "..(Enabled and "ON" or "OFF")
	Circle.Visible = Enabled
	if not Enabled then
		Target = nil
		TargetHumanoid = nil
		TargetCircle.Visible = false
	end
end)

teamBtn.MouseButton1Click:Connect(function()
	TeamCheck = not TeamCheck
	teamBtn.Text = "TeamCheck: "..(TeamCheck and "ON" or "OFF")
end)

wallBtn.MouseButton1Click:Connect(function()
	WallCheck = not WallCheck
	wallBtn.Text = "WallCheck: "..(WallCheck and "ON" or "OFF")
end)

smoothBtn.MouseButton1Click:Connect(function()
	SmoothAim = not SmoothAim
	smoothBtn.Text = "Smooth Aim: "..(SmoothAim and "ON" or "OFF")
end)

partBtn.MouseButton1Click:Connect(function()
	AimPart = AimPart == "Head" and "HumanoidRootPart" or "Head"
	partBtn.Text = "Aim Part: "..AimPart
	Target = nil
	TargetHumanoid = nil
	TargetCircle.Visible = false
end)

iyBtn.MouseButton1Click:Connect(function()
	loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()
end)

fovBox.FocusLost:Connect(function()
	local v = tonumber(fovBox.Text:match("%d+"))
	if v then
		FOV = math.clamp(v, 50, 500)
		Circle.Radius = FOV
		fovBox.Text = "FOV: "..FOV
	end
end)

-- INPUT
UIS.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.UserInputType == Enum.UserInputType.MouseButton2 then
		Holding = true
	end
end)

UIS.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton2 then
		Holding = false
		Target = nil
		TargetHumanoid = nil
		TargetCircle.Visible = false
	end
end)

-- TEAM CHECK
local function IsEnemy(plr)
	if not TeamCheck then return true end
	if not plr.Team or not LocalPlayer.Team then return true end
	return plr.Team ~= LocalPlayer.Team
end

-- WALL CHECK
local function IsVisible(part)
	if not WallCheck then return true end

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Blacklist
	params.FilterDescendantsInstances = {LocalPlayer.Character, Camera}

	local origin = Camera.CFrame.Position
	local direction = (part.Position - origin)

	local result = Workspace:Raycast(origin, direction, params)
	return result and result.Instance:IsDescendantOf(part.Parent)
end

-- TARGET FINDER
local function GetClosest()
	local mousePos = UIS:GetMouseLocation()
	local closest, shortest = nil, FOV
	local humanoid = nil

	for _,plr in ipairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer
		and IsEnemy(plr)
		and plr.Character
		and plr.Character:FindFirstChild(AimPart)
		and plr.Character:FindFirstChild("Humanoid")
		and plr.Character.Humanoid.Health > 0 then

			local part = plr.Character[AimPart]
			if not IsVisible(part) then continue end

			local pos, vis = Camera:WorldToScreenPoint(part.Position)
			if vis then
				local dist = (Vector2.new(pos.X,pos.Y) - mousePos).Magnitude
				if dist < shortest then
					shortest = dist
					closest = part
					humanoid = plr.Character.Humanoid
				end
			end
		end
	end

	return closest, humanoid
end

-- MAIN LOOP
RunService.RenderStepped:Connect(function()
	if not Enabled then return end

	local mousePos = UIS:GetMouseLocation()
	Circle.Position = mousePos

	if not Holding then
		Target = nil
		TargetHumanoid = nil
		TargetCircle.Visible = false
		return
	end

	if TargetHumanoid and TargetHumanoid.Health <= 0 then
		Target = nil
		TargetHumanoid = nil
		TargetCircle.Visible = false
	end

	if not Target then
		Target, TargetHumanoid = GetClosest()
	end

	if Target and Target.Parent and TargetHumanoid and TargetHumanoid.Health > 0 then
		local pos, vis = Camera:WorldToScreenPoint(Target.Position)
		if vis then
			TargetCircle.Visible = true
			TargetCircle.Position = Vector2.new(pos.X, pos.Y)
		end

		local aimCF = CFrame.lookAt(Camera.CFrame.Position, Target.Position)
		Camera.CFrame = SmoothAim and Camera.CFrame:Lerp(aimCF, Smoothness) or aimCF
	else
		TargetCircle.Visible = false
	end
end)
